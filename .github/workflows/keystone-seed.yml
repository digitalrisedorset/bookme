name: Keystone – seed data (sequenced, manual)

on:
  workflow_dispatch:

jobs:
  keystone-seed:
    runs-on: ubuntu-latest
    environment: reactedge

    steps:
      - name: Setup SSH
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.WIDGET_SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.WIDGET_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Run sequenced seed step
        shell: bash
        run: |
          ssh ${{ secrets.WIDGET_SSH_USER }}@${{ secrets.WIDGET_SSH_HOST }} << 'EOF'
            set -e

            cd /var/www/booking-keystone

            echo "▶ Stopping Keystone"
            pm2 stop booking-keystone

            echo "▶ Running sequenced seed step"
            ./seed-data/run-seed.sh

            echo "▶ Restarting Keystone"
            pm2 start booking-keystone

            echo "✔ Seed step completed successfully"
          EOF
