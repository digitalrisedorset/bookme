<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="860" viewBox="0 0 1400 860">
    <defs>
        <style>
            .box { fill:#fff; stroke:#111; stroke-width:2; rx:14; ry:14; }
            .title { font: 700 18px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#111; }
            .text { font: 14px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#111; }
            .small { font: 12px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#111; opacity:.9; }
            .muted { opacity:.75; }
            .arrow { stroke:#111; stroke-width:2.2; fill:none; }
            .dash { stroke-dasharray:7 6; }
            .label { font: 12.5px system-ui, -apple-system, Segoe UI, Roboto, Arial; fill:#111; }
            .pill { fill:#f6f6f6; stroke:#111; stroke-width:1.5; rx:10; ry:10; }
            .ok { fill:#eef9ee; stroke:#111; }
            .warn { fill:#fff7e6; stroke:#111; }
        </style>

        <marker id="arrowHead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L10,3 L0,6 Z" fill="#111"/>
        </marker>
    </defs>

    <!-- Header -->
    <text x="40" y="42" class="title">OAuth + Auth-Bridge + Keystone flow (with cookies + callbacks)</text>
    <text x="40" y="68" class="text muted">Goal: only OAuth server handles Google’s “code”; Auth-Bridge only sets/clears cookie and forwards session refresh.</text>

    <!-- Components row -->
    <!-- Browser/Widget -->
    <rect x="40" y="110" width="280" height="170" class="box"/>
    <text x="60" y="142" class="title">Browser</text>
    <text x="60" y="166" class="text">Host page (WordPress / Magento)</text>
    <text x="60" y="188" class="text">React widget JS</text>
    <rect x="60" y="205" width="240" height="46" class="pill"/>
    <text x="74" y="234" class="small">Stores nothing sensitive; relies on cookie</text>

    <!-- Auth-Bridge -->
    <rect x="390" y="110" width="300" height="170" class="box ok"/>
    <text x="410" y="142" class="title">Auth-Bridge</text>
    <text x="410" y="166" class="text">Sets httpOnly cookie: <tspan font-weight="700">token</tspan></text>
    <text x="410" y="188" class="text">Routes: /auth/google, /auth/auth-callback</text>
    <text x="410" y="210" class="text">Also: /auth/refresh-session, /auth/login, /auth/logout</text>

    <!-- OAuth server -->
    <rect x="760" y="110" width="300" height="170" class="box ok"/>
    <text x="780" y="142" class="title">oauth-express</text>
    <text x="780" y="166" class="text">Handles OAuth code exchange</text>
    <text x="780" y="188" class="text">Issues JWT token</text>
    <text x="780" y="210" class="text">Routes: /google/auth, /google/auth/callback</text>
    <text x="780" y="232" class="text">and /auth/refresh-session, /local/auth</text>

    <!-- Google -->
    <rect x="1130" y="110" width="230" height="170" class="box warn"/>
    <text x="1150" y="142" class="title">Google OAuth</text>
    <text x="1150" y="166" class="text">Auth UI + consent</text>
    <text x="1150" y="188" class="text">Redirects back with</text>
    <text x="1150" y="210" class="text"><tspan font-weight="700">?code=...</tspan></text>

    <!-- Lower row: Keystone + Turnstile -->
    <rect x="40" y="340" width="280" height="150" class="box"/>
    <text x="60" y="372" class="title">Widget API calls</text>
    <text x="60" y="398" class="text">Keystone GraphQL / REST</text>
    <text x="60" y="420" class="text">Uses session token (bearer)</text>
    <text x="60" y="442" class="text">and/or cookie-mediated refresh</text>

    <rect x="390" y="340" width="300" height="150" class="box"/>
    <text x="410" y="372" class="title">Keystone</text>
    <text x="410" y="398" class="text">Protected mutations/queries</text>
    <text x="410" y="420" class="text">Validates JWT / session</text>
    <text x="410" y="442" class="text">Creates orders / users / events</text>

    <rect x="760" y="340" width="300" height="150" class="box"/>
    <text x="780" y="372" class="title">Cloudflare Turnstile</text>
    <text x="780" y="398" class="text">Human verification token</text>
    <text x="780" y="420" class="text">Bridge endpoint: /verify-human</text>

    <!-- Flow 1: Google login start -->
    <text x="40" y="535" class="title">Flow A — Google login (recommended wiring)</text>

    <!-- A1 Browser -> Bridge /auth/google -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M320,190 C350,190 360,190 390,190"/>
    <rect x="250" y="155" width="150" height="28" class="pill"/>
    <text x="260" y="174" class="label">1) GET /auth/google</text>

    <!-- A2 Bridge -> OAuth /google/auth -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M690,190 C720,190 730,190 760,190"/>
    <rect x="602" y="205" width="210" height="30" class="pill"/>
    <text x="612" y="225" class="label">2) 302 → oauth /google/auth</text>

    <!-- A3 OAuth -> Google -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M1060,190 C1090,190 1100,190 1130,190"/>
    <rect x="1020" y="155" width="160" height="28" class="pill"/>
    <text x="1030" y="174" class="label">3) redirect to Google</text>

    <!-- A4 Google -> OAuth callback (code) -->
    <path class="arrow dash" marker-end="url(#arrowHead)" d="M1130,250 C1070,285 980,300 900,290 C840,282 805,265 760,248"/>
    <rect x="940" y="288" width="320" height="32" class="pill"/>
    <text x="950" y="309" class="label">4) Google → oauth GET /google/auth/callback?code=...</text>

    <!-- A5 OAuth -> Bridge token callback -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M760,250 C700,300 650,320 580,320 C520,320 470,295 430,250"/>
    <rect x="520" y="300" width="420" height="34" class="pill"/>
    <text x="530" y="322" class="label">5) oauth issues JWT and 302 → bridge /auth/auth-callback?token=...&amp;returnTo=...</text>

    <!-- A6 Bridge sets cookie and redirects back -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M390,250 C340,300 280,320 210,320 C130,320 90,290 60,250"/>
    <rect x="110" y="300" width="420" height="34" class="pill"/>
    <text x="120" y="322" class="label">6) bridge sets httpOnly cookie “token” and 302 → returnTo (host page)</text>

    <!-- Cookie note -->
    <rect x="40" y="610" width="650" height="90" class="box"/>
    <text x="60" y="642" class="title">Cookie contract (bridge-owned)</text>
    <text x="60" y="668" class="text">Auth-Bridge sets: <tspan font-weight="700">Set-Cookie: token=&lt;jwt&gt;; HttpOnly; Secure; SameSite=Lax/None; Domain=...</tspan></text>
    <text x="60" y="690" class="text muted">Widget never reads token directly; browser sends cookie automatically to the bridge.</text>

    <!-- Flow B: Session refresh -->
    <text x="740" y="535" class="title">Flow B — Session refresh (widget → bridge → oauth)</text>

    <!-- B1 Widget -> Bridge refresh-session -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M320,430 C350,430 360,430 390,430"/>
    <rect x="210" y="398" width="220" height="30" class="pill"/>
    <text x="220" y="419" class="label">7) POST /auth/refresh-session</text>

    <!-- B2 Bridge -> OAuth refresh-session with bearer -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M690,430 C720,430 730,430 760,430"/>
    <rect x="560" y="446" width="360" height="34" class="pill"/>
    <text x="570" y="468" class="label">8) bridge reads cookie token → calls oauth /auth/refresh-session (Authorization: Bearer ...)</text>

    <!-- B3 OAuth -> Bridge returns user/null -->
    <path class="arrow dash" marker-end="url(#arrowHead)" d="M760,458 C720,500 650,520 540,520 C470,520 430,500 390,458"/>
    <rect x="460" y="514" width="300" height="30" class="pill"/>
    <text x="470" y="535" class="label">9) returns { user } or { user:null }</text>

    <!-- Keystone calls -->
    <text x="40" y="742" class="title">Flow C — Keystone calls (after login)</text>
    <path class="arrow" marker-end="url(#arrowHead)" d="M320,400 C340,395 360,390 390,385"/>
    <rect x="90" y="760" width="560" height="70" class="box"/>
    <text x="110" y="792" class="text">
        10) Widget calls Keystone (GraphQL/REST) using authenticated context.
    </text>
    <text x="110" y="815" class="small muted">
        Typical: widget holds “is logged in” from refresh-session; Keystone validates JWT / ACL on protected operations.
    </text>

    <!-- Turnstile -->
    <path class="arrow" marker-end="url(#arrowHead)" d="M320,455 C520,510 650,520 760,455"/>
    <rect x="740" y="760" width="620" height="70" class="box"/>
    <text x="760" y="792" class="text">
        Optional: Turnstile gate before sensitive Keystone operations (signup/order).
    </text>
    <text x="760" y="815" class="small muted">
        Widget obtains turnstile token → POST bridge /verify-human → allow action (then call Keystone).
    </text>

    <!-- Warning about the miswire -->
    <rect x="740" y="610" width="620" height="90" class="box warn"/>
    <text x="760" y="642" class="title">Hard rule (prevents “Cannot GET /google/auth/callback”)</text>
    <text x="760" y="668" class="text">Google redirect URI must point to <tspan font-weight="700">oauth-express</tspan> callback (the service that exchanges <tspan font-weight="700">code</tspan>).</text>
    <text x="760" y="690" class="text muted">Auth-Bridge should only receive <tspan font-weight="700">token</tspan> on /auth/auth-callback.</text>
</svg>
